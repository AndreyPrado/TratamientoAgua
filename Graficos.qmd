---
title: "Graficos"
author: "Diego Vega Víquez"
format: pdf
---

```{r}
#| echo: false
#| message: false
#| warning: false

library(readxl)
library(openxlsx)
library(tidyverse)
library(viridis)
library(hms)
library(leaflet)
library(ggcorrplot)
library(skimr)
library(GGally) 
library(kableExtra)
```

# Resultados
```{r}
base <- read_excel("data/base_agua_limpia.xlsx")
str(base)

# Extra: volver a poner las categóricas como factores y la fecha como Date por que
# al pasarse a excel pierde esta característica.

base$sitio <- as.factor(base$sitio)
base$cuerpo <- as.factor(base$cuerpo)
base$ubi_muestra <- as.factor(base$ubi_muestra)
base <- base %>% mutate(across(
  c(sitio, ubi_muestra, cuerpo),
  as.factor
))
table(base$sitio)
table(base$ubi_muestra)
table(base$cuerpo)
```

# Gráficos

## Distribución de la demanda biológica de oxígeno antes del tratamiento
```{r}
#| message: false
#| warning: false
#| echo: false
base %>% ggplot(aes(x=dbof))+
  geom_histogram(binwidth = 5, fill = viridis(1), color = "black", alpha= 0.8)+
  labs(title = "Distribución del DBOF (Demanda biológica de Oxígeno)",
       x = "DBO (mg/L) Antes del Tratamiento",
       y = "Frecuencia") + 
  theme_minimal()
```
## Distribución de la demanda biológica de oxígeno posterior al tratamiento
```{r}
#| message: false
#| warning: false
#| echo: false
base %>% ggplot(aes(x=dboj))+
  geom_histogram(binwidth = 5, fill = viridis(1), color = "black", alpha= 0.8)+
  labs(title = "Distribución del DBOJ (Demanda biológica de Oxígeno)",
       x = "DBO (mg/L) Posterior del Tratamiento",
       y = "Frecuencia") + 
  theme_minimal()
```
## Boxplot de la demanda biológica de oxígeno antes al tratamiento
```{r}
#| message: false
#| warning: false
#| echo: false
base %>% 
  filter(!is.na(cuerpo)) %>% filter(dbof < 50) %>% ggplot(aes(x = cuerpo, y = dbof, fill = cuerpo))+
  geom_boxplot(alpha = 0.8)+
  scale_fill_viridis_d()+
  labs(title = "DBO antes del tratamiento\n según el cuerpo de agua",
       x = "Cuerpo de agua",
       y = "DBO (mg/L)")+
  theme_minimal(base_size = 15)+
  theme(legend.position = "none")
```
## Boxplot de la demanda biológica de oxígeno posterior al tratamiento
```{r}
#| message: false
#| warning: false
#| echo: false
base %>% 
  filter(!is.na(cuerpo)) %>% filter(dboj < 50) %>% ggplot(aes(x = cuerpo, y = dboj, fill = cuerpo))+
  geom_boxplot(alpha = 0.8)+
  scale_fill_viridis_d()+
  labs(title = "DBO posterior del tratamiento\n según el cuerpo de agua",
       x = "Cuerpo de agua",
       y = "DBO (mg/L)")+
  theme_minimal(base_size = 15)+
  theme(legend.position = "none")
```
## Distribución de la demanda química de oxígeno antes del tratamiento
```{r}
#| message: false
#| warning: false
#| echo: false
base %>% ggplot(aes(x=dqof))+
  geom_histogram(binwidth = 65, fill = viridis(1), color = "black", alpha= 0.8)+
  labs(title = "Distribución del DQOF (Demanda química de Oxígeno)",
       x = "DQO (mg/L) Antes del Tratamiento",
       y = "Frecuencia") + 
  theme_minimal()
```
## Distribución de la demanda biológica de oxígeno posterior al tratamiento
```{r}
#| message: false
#| warning: false
#| echo: false

base %>% ggplot(aes(x=dqoj))+
  geom_histogram(binwidth = 150, fill = viridis(1), color = "black", alpha= 0.8)+
  labs(title = "Distribución del DQOJ (Demanda química de Oxígeno)",
       x = "DBO (mg/L) Posterior del Tratamiento",
       y = "Frecuencia") + 
  theme_minimal()
```
## Boxplot de la demanda biológica de oxígeno antes al tratamiento
```{r}
#| message: false
#| warning: false
#| echo: false
base %>% 
  filter(!is.na(cuerpo))  %>% ggplot(aes(x = cuerpo, y = dbof, fill = cuerpo))+
  geom_boxplot(alpha = 0.8)+
  scale_fill_viridis_d()+
  labs(title = "DBO antes del tratamiento\n según el cuerpo de agua",
       x = "Cuerpo de agua",
       y = "DBO (mg/L)")+
  theme_minimal(base_size = 15)+
  theme(legend.position = "none")
```
## Boxplot de la demanda biológica de oxígeno posterior al tratamiento
```{r}
#| message: false
#| warning: false
#| echo: false
base %>% 
  filter(!is.na(cuerpo)) %>% filter(dqoj < 50) %>% ggplot(aes(x = cuerpo, y = dboj, fill = cuerpo))+
  geom_boxplot(alpha = 0.8)+
  scale_fill_viridis_d()+
  labs(title = "DQO posterior del tratamiento\n según el cuerpo de agua",
       x = "Cuerpo de agua",
       y = "DQO (mg/L)")+
  theme_minimal(base_size = 15)+
  theme(legend.position = "none")
```
## Boxplot de DBO según la calidad del agua
```{r}
#| message: false
#| warning: false
#| echo: false
base %>% 
  ggplot(aes(x= oxigeno, y = dqof)) + 
  geom_point(size = 3, alpha = 0.8)+
  scale_color_viridis() + 
  labs(title = "Oxígeno disuelto vs DBO",
       x = "Oxígeno disuelto mg/L", 
       y = "DBO mg/L")+
  theme_minimal(base_size = 15)
```
```{r}
#| message: false
#| warning: false
#| echo: false
base %>% 
  ggplot(aes(x=fecharecolectaf, y = dbof, color = sitio))+
  geom_line(size = 1) + 
  geom_point(size = 2) + 
  scale_color_viridis_d() +
labs(title = "Evolución del DBO en el tiempo por sitio",
     x = "Fecha",
     y = "DBO mg/L")+
  theme_minimal(base_size = 15)
```
## Heatmap de Correlación
```{r}
#| fig-width: 10
#| fig-height: 10
#| message: false
#| warning: false
#| echo: false
val_num <- base %>% 
  select(where(is.numeric)) 
matriz <- cor(val_num, use = "pairwise.complete.obs")
ggcorrplot(matriz, method = "square", type = "lower",
           lab = FALSE, lab_size = 3,
           colors = c("#6D9EC1", "white", "#E46726"),
           title = "Mapa de Calor de Correlaciones para variables numéricas",
           ggtheme = ggplot2::theme_minimal())
```

## Matriz de Dispersión: DBO, DQO y Variables Relevantes
```{r}
#| fig-width: 20
#| fig-height: 10
#| message: false
#| warning: false
#| echo: false
base %>%
    select(dboj, dqoj, oxigeno, ph, amonio, nitratos, tempaguaj) %>%
    na.omit() %>%
    ggpairs()
```
## Matriz de correlaciones visuales y distribuciones para variables fisicoquímicas
```{r}
#| fig-width: 20
#| fig-height: 10
#| message: false
#| warning: false
#| echo: false

base %>%
  select(cuerpo, dboj, dqoj, oxigeno, ph, amonio, nitratos, tempaguaj) %>%
  na.omit() %>%
  ggpairs(aes(color = cuerpo, alpha = 0.7),
          upper = list(continuous = wrap("cor", size = 3.5)),
          lower = list(continuous = wrap("smooth", alpha = 0.4, size = 0.5)),
          diag  = list(continuous = wrap("densityDiag", alpha = 0.5))) +
  theme_minimal(base_size = 12)
```
## Ubicación
```{r}
#| message: false
#| warning: false
#| echo: false

base %>%
  filter(!is.na(oxigeno), is.finite(oxigeno), oxigeno < 20) %>%
  ggplot(aes(x = ubi_muestra, y = oxigeno, fill = ubi_muestra)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Oxígeno disuelto según ubicación (valores < 20 mg/L)",
       x = "", y = "Oxígeno (mg/L)") +
  theme_minimal()
```

## DQO por tipo de Cuerpo
```{r}
#| message: false
#| warning: false
#| echo: false

ggplot(base, aes(x = cuerpo, y = dqof, fill = cuerpo)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Demanda Química de Oxígeno (DQO) por tipo de cuerpo de agua",
       x = "Tipo de cuerpo", y = "DQO") +
  theme_minimal()
```
## Distribución conjunta (facet) para varias variables clave
```{r}
#| message: false
#| warning: false
#| echo: false

base_long <- base %>%
  select(ubi_muestra, cuerpo, oxigeno, salinidad, ph, chla_agua, dqof) %>%
  pivot_longer(cols = c(oxigeno, salinidad, ph, chla_agua, dqof),
               names_to = "variable", values_to = "valor") %>%
  filter(!is.na(valor), is.finite(valor))  # Elimina NA e infinitos

# Gráfico
ggplot(base_long, aes(x = ubi_muestra, y = valor, fill = ubi_muestra)) +
  geom_boxplot(alpha = 0.8, outlier.shape = 16, outlier.color = "black") +
  facet_wrap(~ variable, scales = "free_y", ncol = 3) +
  labs(
    title = "Distribuciones de variables seleccionadas según ubicación vertical",
    x = "Ubicación de la muestra",
    y = "Valor medido"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text.x = element_text(angle = 0, vjust = 0.5),
    legend.position = "bottom",
    strip.text = element_text(face = "bold")
  )
```

```{r}
#| fig-width: 10
#| fig-height: 5
#| message: false
#| warning: false
#| echo: false

base %>%
    filter(!is.na(oxigeno), is.finite(oxigeno)) %>%
    mutate(sitio = factor(sitio, levels = unique(sitio))) %>% ggplot(aes(x = sitio, y = oxigeno, fill = ubi_muestra)) +
    geom_boxplot(outlier.shape = 21, outlier.fill = "black", outlier.size = 2,
                 position = position_dodge(width = 0.8)) +
    labs(
        title = "Oxígeno disuelto por sitio y profundidad",
        x = "Sitio de muestreo",
        y = "Oxígeno disuelto (mg/L)",
        fill = "Ubicación"
    ) +
    scale_fill_manual(values = c("Fondo" = "#F8766D", "Superficie" = "#00BFC4")) +
    theme_minimal(base_size = 13) +
    theme(
        axis.text.x = element_text(angle = 30, hjust = 1),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        panel.grid.major.x = element_blank()
    )

base %>%
    filter(!is.na(oxigeno), is.finite(oxigeno), !sitio %in% c("Claro", "Río Aguijitas")) %>%
    mutate(sitio = factor(sitio, levels = unique(sitio))) %>%
    ggplot(aes(x = sitio, y = oxigeno, fill = ubi_muestra)) +
    geom_boxplot(outlier.shape = 21, outlier.fill = "black", outlier.size = 2,
                 position = position_dodge(width = 0.8)) +
    coord_cartesian(ylim = c(0, 7.5)) +  # <-- eje Y ajustado
    labs(
        title = "Oxígeno disuelto por sitio y profundidad sin Claro ni Rio Aguijitas",
        x = "Sitio de muestreo",
        y = "Oxígeno disuelto (mg/L)",
        fill = "Ubicación"
    ) +
    scale_fill_manual(values = c("Fondo" = "#F8766D", "Superficie" = "#00BFC4")) +
    theme_minimal(base_size = 13) +
    theme(
        axis.text.x = element_text(angle = 30, hjust = 1),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        panel.grid.major.x = element_blank()
    )
```

```{r}
#| message: false
#| warning: false
#| echo: false

kableExtra::kable(base %>%
  count(sitio, cuerpo) %>%
  tidyr::pivot_wider(names_from = cuerpo, values_from = n, values_fill = 0))
```

```{r}
#| fig-width: 25
#| fig-height: 10
#| message: false
#| warning: false
#| echo: false

ggplot(base, aes(x = interaction(sitio, ubi_muestra), y = dqof, fill = cuerpo)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "DQO según sitio, ubicación y tipo de cuerpo", x = "Sitio + ubicación", y = "DQO")
```
```{r}
base %>%
  group_by(sitio, cuerpo, ubi_muestra) %>%
  summarise(
    n = n(),
    dqof_mediana = median(dqof, na.rm = TRUE),
    ph_promedio = mean(ph, na.rm = TRUE),
    salinidad_sd = sd(salinidad, na.rm = TRUE)
  ) %>%
  arrange(desc(dqof_mediana)) %>% kableExtra::kable()
```

